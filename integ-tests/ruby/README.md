# BAML Ruby Integration Tests

> **⚠️ IMPORTANT NOTE**
>
> This document was initially generated by an AI assistant and should be taken with a grain of salt. While it provides a good starting point, some information might be inaccurate or outdated. We encourage contributors to manually update this document and remove this note once the content has been verified and corrected by the team.
>
> If you find any inaccuracies or have improvements to suggest, please feel free to submit a PR updating this guide.

This directory contains integration tests for the BAML Ruby client. These tests verify the functionality of the Ruby client library and ensure it works correctly with various BAML features.

## Prerequisites

- [mise](https://mise.jdx.dev) for Ruby version management (installed via Homebrew)
- Rust toolchain (for building the Ruby client)
- BAML CLI installed
- Infisical CLI installed

## Setup

1. Install mise (if not already installed):
```bash
brew install mise
```

2. Set up mise in your shell (optional, but recommended):
```bash
# For bash
echo 'eval "$(~/.local/bin/mise activate bash)"' >> ~/.bashrc

# For zsh
echo 'eval "$(~/.local/bin/mise activate zsh)"' >> ~/.zshrc
```

3. Build the Ruby client:
```bash
(cd ../../engine/language_client_ruby && mise exec -- rake compile)
```

4. Install dependencies:
```bash
mise exec -- bundle install
```

5. Generate the BAML client code:
```bash
mise exec -- baml-cli generate --from ../baml_src
```

## Running Tests

### Run all tests
```bash
infisical run --env=test -- mise exec -- rake test
```

### Run specific tests
```bash
# Run a specific test file
infisical run --env=test -- mise exec -- ruby test_functions.rb

# Run a specific test
infisical run --env=test -- mise exec -- ruby test_functions.rb --name test_name
```

### Environment Variables
- Tests can be run with environment variables using `infisical` (default)
```bash
infisical run --env=test -- mise exec -- rake test
```

- Alternatively, you can use a .env file with dotenv:
```bash
mise exec -- rake test
```

## Project Structure

- `baml_client/` - Generated BAML client code
- `test_functions.rb` - Main test file
- `streaming-example.rb` - Streaming functionality examples
- `tracing-demo1.rb` - Tracing functionality examples
- `Gemfile` - Ruby dependencies
- `Rakefile` - Test and build tasks

## Debugging Tests

### VS Code Setup
1. Install the [Ruby Test Explorer](https://marketplace.visualstudio.com/items?itemName=connorshea.vscode-ruby-test-adapter) extension for VS Code
   - This provides inline test running and debugging capabilities
   - Adds "Run Test" and "Debug Test" buttons above each test

2. Create a launch configuration in `.vscode/launch.json`:
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug Tests",
      "type": "ruby",
      "request": "launch",
      "runtimeExecutable": "infisical",
      "runtimeArgs": [
        "run",
        "--env=test",
        "--",
        "mise",
        "exec",
        "--"
      ],
      "program": "rake",
      "args": ["test"],
      "console": "integratedTerminal"
    }
  ]
}
```

3. Set breakpoints in your test files
4. Use the VS Code debugger to run and debug tests, or use the Test Explorer's inline buttons

### Debug Logs
- Add `puts` statements in your tests
- Set the environment variable `BAML_LOG=trace` for detailed BAML client logs:
```bash
BAML_LOG=trace infisical run --env=test -- mise exec -- rake test
```

## Troubleshooting

### Common Issues

1. **Missing API Keys**
   - Ensure all required API keys are set in your environment
   - Check that `.env` file exists if not using Infisical
   - Verify Infisical is properly configured if using `infisical run`

2. **Build Issues**
   - If you get Rust compilation errors:
     ```bash
     # Clean and rebuild
     (cd ../../engine/language_client_ruby && mise exec -- rake clean compile)
     ```
   - For Bundler issues:
     ```bash
     mise exec -- bundle install --clean
     ```

3. **Ruby Version Issues**
   - Ensure mise is properly set up:
     ```bash
     mise install
     mise exec -- ruby --version
     ```
   - If mise isn't picking up the right version:
     ```bash
     mise trust
     mise install
     ```

4. **BAML Client Generation Issues**
   - Ensure BAML CLI is up to date
   - Check that BAML source files in `../baml_src` are valid
   - Try regenerating the client:
     ```bash
     rm -rf baml_client
     mise exec -- baml-cli generate --from ../baml_src
     ```

5. **Test Load Path Issues**
   - If tests can't find files, ensure you're running from the correct directory
   - Try running with full paths:
     ```bash
     mise exec -- ruby -I. test_functions.rb
     ```

### Getting Help
- Run tests with verbose output:
  ```bash
  infisical run --env=test -- mise exec -- rake test TESTOPTS="--verbose"
  ```
- Use Ruby's debug mode:
  ```bash
  infisical run --env=test -- mise exec -- ruby -rdebug test_functions.rb
  ```
- Check the test output for error backtraces and assertion details

## Adding New Tests

### 1. Define BAML Files
First, add your test definitions in the BAML source files (see [BAML Source README](../baml_src/README.md)):
1. Add clients in `baml_src/clients.baml`
2. Add functions and tests in `baml_src/test-files/providers/`

### 2. Generate Ruby Client
```bash
mise exec -- baml-cli generate --from ../baml_src
```
This will create new Ruby client code in `baml_client/`.

### 3. Create Test File
Create a new test file or add to `test_functions.rb`:
```ruby
require 'minitest/autorun'
require 'minitest/reporters'
require_relative './baml_client/functions'

class TestAnthropic < Minitest::Test
  def test_basic_completion
    result = TestAnthropicCompletion.call(
      input: "What is the capital of France?"
    )
    assert_equal "Paris", result
  end

  def test_error_handling
    assert_raises(StandardError) do
      TestAnthropicCompletion.call(
        input: "Test input"
      )
    end
  end
end
```

### 4. Run Your Tests
```bash
# Run all tests
infisical run --env=test -- mise exec -- rake test

# Run specific test
infisical run --env=test -- mise exec -- ruby test_functions.rb -n test_basic_completion
```

### Test File Organization
- Group related tests in classes
- Inherit from `Minitest::Test`
- Name test methods with `test_` prefix
- Use descriptive test names

### Best Practices
1. **Test Setup**
   - Import functions from `baml_client`
   - Use Minitest setup methods for common setup:
     ```ruby
     def setup
       # Common setup code
     end
     ```
   - Add proper error handling tests

2. **Assertions**
   - Use Minitest assertions
   - Test both success and error cases
   - Add timeout for long-running tests:
     ```ruby
     def test_with_timeout
       Timeout.timeout(30) do
         # Test code
       end
     end
     ```

3. **Environment**
   - Ensure all required env vars are set
   - Use test-specific API keys
   - Handle rate limiting appropriately

4. **Ruby-Specific**
   - Use Sorbet type checking
   - Handle async operations properly
   - Follow Ruby naming conventions