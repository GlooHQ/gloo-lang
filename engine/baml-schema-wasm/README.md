# BAML WebAssembly Schema

> **⚠️ IMPORTANT NOTE**
>
> This document was initially generated by an AI assistant and should be taken with a grain of salt. While it provides a good starting point, some information might be inaccurate or outdated. We encourage contributors to manually update this document and remove this note once the content has been verified and corrected by the team.
>
> If you find any inaccuracies or have improvements to suggest, please feel free to submit a PR updating this guide.

WebAssembly bindings for BAML schema validation and runtime, enabling browser-based BAML functionality.

## Components

```
baml-schema-wasm/
├── src/
│   ├── lib.rs         # Wasm module definitions
│   ├── schema.rs      # Schema validation
│   ├── runtime.rs     # Browser runtime
│   └── utils.rs       # Wasm utilities
├── js/               # JavaScript wrapper
│   ├── index.ts     # TypeScript entry
│   └── types.ts     # Type definitions
└── tests/           # Wasm tests
```

## Features

- Browser-compatible BAML runtime
- Schema validation in the browser
- TypeScript type definitions
- Streaming response support
- Error handling with stack traces

## Development

### Prerequisites

```bash
# Install wasm-pack
curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

# Install development tools
npm install
```

### Building

```bash
# Development build
wasm-pack build --dev

# Release build
wasm-pack build --release --target web
```

### Testing

```bash
# Run Wasm tests
wasm-pack test --node

# Run browser tests
npm test
```

## Schema Validation

### JavaScript Usage

```typescript
import { BamlSchema } from '@baml/schema-wasm';

const schema = new BamlSchema(`
  class User {
    name string
    age int
  }
`);

const isValid = schema.validate({
  name: "John",
  age: 30
});
```

### Wasm Implementation

```rust
#[wasm_bindgen]
impl BamlSchema {
    pub fn validate(&self, value: JsValue) -> Result<bool, JsError> {
        let value: serde_json::Value = value.into_serde()?;
        self.schema.validate(&value)
            .map_err(|e| JsError::new(&e.to_string()))
    }
}
```

## Browser Runtime

### Streaming Support

```typescript
import { BamlRuntime } from '@baml/schema-wasm';

const runtime = new BamlRuntime();
const stream = runtime.streamResponse(async function* () {
    yield "Hello";
    yield "World";
});
```

### Implementation

```rust
#[wasm_bindgen]
impl BamlRuntime {
    #[wasm_bindgen(js_name = streamResponse)]
    pub fn stream_response(&self) -> Result<JsValue, JsError> {
        let (tx, rx) = futures::channel::mpsc::channel(32);
        let stream = wasm_streams::ReadableStream::from_raw(rx);
        Ok(stream.into_raw())
    }
}
```

## Error Handling

```rust
// Convert Rust errors to JavaScript
impl From<BamlError> for JsError {
    fn from(err: BamlError) -> Self {
        JsError::new(&err.to_string())
    }
}
```

## Package Configuration

### package.json

```json
{
  "name": "@baml/schema-wasm",
  "version": "1.0.0",
  "type": "module",
  "main": "dist/node/index.js",
  "module": "dist/web/index.js",
  "types": "dist/index.d.ts",
  "files": [
    "dist",
    "README.md"
  ]
}
```

## Browser Integration

### ESM Usage

```html
<script type="module">
  import { BamlSchema } from '@baml/schema-wasm';

  async function init() {
    const schema = new BamlSchema();
    // Use schema
  }
</script>
```

## Debugging

1. **Build Issues**:
```bash
# Clean build
rm -rf pkg/
wasm-pack build --verbose

# Check wasm-pack version
wasm-pack --version
```

2. **Runtime Issues**:
```bash
# Enable debug logging
RUST_LOG=debug wasm-pack test

# Check browser console
console.log(BamlSchema.version());
```

3. **Common Problems**:
- WebAssembly support in browser
- Memory management issues
- Cross-origin restrictions
