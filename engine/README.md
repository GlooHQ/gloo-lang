# BAML Engine

> **⚠️ IMPORTANT NOTE**
>
> This document was initially generated by an AI assistant and should be taken with a grain of salt. While it provides a good starting point, some information might be inaccurate or outdated. We encourage contributors to manually update this document and remove this note once the content has been verified and corrected by the team.
>
> If you find any inaccuracies or have improvements to suggest, please feel free to submit a PR updating this guide.

The BAML Engine is the core Rust implementation of the BAML (Boundary AI Markup Language) compiler and runtime system. It processes BAML source files (`.baml`) and generates type-safe client SDKs for multiple programming languages, enabling seamless integration with LLM providers like OpenAI and Anthropic.

> **Note**: This is the engine implementation documentation. For general BAML usage and getting started, see the [main BAML documentation](../README.md).

## Quick Links
- [Main Project Documentation](../README.md)
- [Contributing Guidelines](../CONTRIBUTING.md)
- [BAML Documentation](https://docs.boundaryml.com)
- [Discord Community](https://discord.gg/BTNBeXGuaS)

## Overview

BAML outperforms traditional methods for obtaining structured data from LLMs, even with GPT-3.5, and surpasses models fine-tuned for tool use on the [Berkeley Function Calling Benchmark](https://gorilla.cs.berkeley.edu/leaderboard.html). The engine is responsible for:

1. **Compilation**: Converting BAML source files into type-safe SDKs
2. **Runtime**: Managing LLM interactions, retries, and streaming
3. **Type Safety**: Ensuring robust parsing and validation of LLM responses
4. **Code Generation**: Producing idiomatic code for multiple languages

## Architecture Overview

For a detailed overview of BAML's architecture and design principles, see our [Architecture Documentation](../docs/architecture.md).

```
┌─────────────────┐     ┌──────────────────┐     ┌────────────────────┐
│   BAML Source   │     │   BAML Engine    │     │  Language Clients  │
│    (.baml)      │────▶│  (Rust Compiler) │────▶│ Python/TS/Ruby/... │
└─────────────────┘     └──────────────────┘     └────────────────────┘
                               │                           │
                               │                           │
                               ▼                           ▼
                        ┌──────────────┐           ┌──────────────┐
                        │  IR + Types  │           │ LLM Provider │
                        │  Validation  │           │   Runtime    │
                        └──────────────┘           └──────────────┘
```

## Project Structure

The engine is organized into several key components:

### Core Components

- [**baml-lib/**](baml-lib/README.md) - Core compiler and type system
  - Parser and AST handling
  - Type system implementation
  - Code generation framework
  - Intermediate representation (IR)

- [**baml-runtime/**](baml-runtime/README.md) - Runtime engine
  - LLM provider integrations (OpenAI, Anthropic, etc.)
  - Function execution and retry logic
  - Response streaming and caching
  - Error handling and recovery

- [**bstd/**](bstd/README.md) - Standard library
  - Common text processing functions
  - JSON manipulation utilities
  - Standard type definitions
  - Shared runtime utilities

### Language Clients

- [**language_client_python/**](language_client_python/README.md)
  - PyO3-based Python bindings
  - Zero-copy data transfer
  - Pydantic model integration
  - Async/await support

- [**language_client_typescript/**](language_client_typescript/README.md)
  - Node-API (N-API) bindings
  - Promise-based async support
  - ESM and CommonJS compatibility
  - TypeScript type definitions

- [**language_client_ruby/**](language_client_ruby/README.md)
  - FFI-based Ruby bindings
  - Fiber-based async support
  - Gem packaging
  - Ruby type system integration

### Web Integration

- [**baml-schema-wasm/**](baml-schema-wasm/README.md)
  - WebAssembly bindings
  - Browser-based schema validation
  - Streaming response support
  - TypeScript integration

### Code Generation

- [**language_client_codegen/**](language_client_codegen/README.md)
  - Language-specific code generators
  - Template system
  - Type mappings
  - Client SDK generation

For a comprehensive guide on how code generation works, see our [Code Generation Guide](../docs/code-generation.md).

## Prerequisites

Required tools (with installation links):

- [Rust toolchain](https://rustup.rs/) (latest stable version)
- [mise](https://mise.jdx.dev/getting-started.html) for version management
- [direnv](https://direnv.net/docs/installation.html) for environment management
- [clang](https://clang.llvm.org/get_started.html) for native extensions

Language-specific requirements:
- Python: `pip install maturin pytest`
- TypeScript: `npm install -g pnpm`
- Ruby: `gem install bundler`
- WebAssembly: `curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh`

## Quick Start

1. **Setup Environment**:
```bash
# Install dependencies
brew install mise direnv llvm  # macOS
# or
apt install direnv clang      # Ubuntu

# Configure shell
echo 'eval "$(direnv hook zsh)"' >> ~/.zshrc
echo 'eval "$(mise activate zsh)"' >> ~/.zshrc
```

2. **Build Engine**:
```bash
cd engine
cargo build
```

3. **Run Tests**:
```bash
# Unit tests
cargo test

# Integration tests
cd ../integ-tests && ./run-tests.sh
```

## Development Workflow

1. **Compiler Development** (baml-lib):
   - Modify parser in `baml-lib/src/parser`
   - Update type system in `baml-lib/src/types`
   - Run `cargo test` in `baml-lib`

2. **Runtime Development** (baml-runtime):
   - Add/modify providers in `baml-runtime/src/providers`
   - Update runtime features in `baml-runtime/src/runtime`
   - Test with `cargo test` in `baml-runtime`

3. **Language Client Development**:
   - Python: Use `maturin develop` for rapid testing
   - TypeScript: Use `pnpm build:debug` for development
   - Ruby: Use `bundle exec rake compile` for building

4. **Integration Testing**:
   ```bash
   # Full integration test suite
   cd ../integ-tests && ./run-tests.sh

   # Language-specific tests
   cd ../integ-tests/typescript && pnpm test
   cd ../integ-tests/python && pytest
   cd ../integ-tests/ruby && bundle exec rake test
   ```

## Common Development Tasks

### Adding a New Language Client

1. Create new directory: `language_client_<lang>`
2. Implement FFI/bindings using appropriate tool:
   - Python: PyO3
   - TypeScript: Node-API
   - Ruby: FFI
3. Add language-specific type conversions
4. Implement async runtime support
5. Add tests and documentation

### Adding a New LLM Provider

1. Add provider module in `baml-runtime/src/providers`
2. Implement provider trait
3. Add configuration options
4. Add integration tests
5. Update documentation

### Modifying the Type System

1. Update AST definitions in `baml-lib/src/ast`
2. Modify type checker in `baml-lib/src/types`
3. Update code generation templates
4. Add test cases
5. Update documentation

## Contributing

1. Read the [main contributing guidelines](../CONTRIBUTING.md)
2. Join our [Discord community](https://discord.gg/BTNBeXGuaS)
3. Check component-specific documentation
4. Submit PRs with appropriate tests

## Debugging

Each component has specific debugging instructions in its README. Common tools:

1. **Rust Debugging**:
```bash
RUST_LOG=debug cargo test
RUST_BACKTRACE=1 cargo run
```

2. **Language Client Debugging**:
```bash
# Python
RUST_LOG=debug pytest -vv

# TypeScript
DEBUG=baml:* pnpm test

# Ruby
BAML_LOG=debug bundle exec rake test
```

3. **Integration Test Debugging**:
```bash
# Enable verbose output
BAML_DEBUG=1 ./run-tests.sh
```

## License

Apache License 2.0 - See [LICENSE](LICENSE) for details