# BAML Debugging Guide

> **⚠️ IMPORTANT NOTE**
>
> This document was initially generated by an AI assistant and should be taken with a grain of salt. While it provides a good starting point, some information might be inaccurate or outdated. We encourage contributors to manually update this document and remove this note once the content has been verified and corrected by the team.
>
> If you find any inaccuracies or have improvements to suggest, please feel free to submit a PR updating this guide.

This guide provides comprehensive information about debugging BAML projects, from compiler issues to runtime problems.

## Table of Contents

1. [Common Issues](#common-issues)
2. [Debugging Tools](#debugging-tools)
3. [Compiler Debugging](#compiler-debugging)
4. [Runtime Debugging](#runtime-debugging)
5. [Language Client Debugging](#language-client-debugging)
6. [Integration Test Debugging](#integration-test-debugging)
7. [VSCode Extension Debugging](#vscode-extension-debugging)

## Common Issues

### Compiler Issues

1. **Type Checking Errors**
   ```
   error: Type mismatch
   --> src/main.baml:10:5
   |
   10 |     age: string
   |     ^^^ expected int, found string
   ```
   - Check type definitions in your BAML files
   - Verify type mappings in generated code
   - Look for missing type conversions

2. **Parser Errors**
   ```
   error: Unexpected token
   --> src/main.baml:15:10
   |
   15 |   class {
   |          ^ expected identifier
   ```
   - Check syntax in BAML files
   - Verify file encoding (use UTF-8)
   - Look for missing semicolons or braces

3. **Code Generation Errors**
   ```
   error: Failed to generate Python client
   cause: Invalid type mapping for custom type 'MyType'
   ```
   - Check language-specific type mappings
   - Verify template syntax
   - Look for unsupported features

### Runtime Issues

1. **Provider Connection Errors**
   ```
   error: Failed to connect to OpenAI API
   cause: Invalid API key or network timeout
   ```
   - Verify API keys in environment variables
   - Check network connectivity
   - Validate provider configuration

2. **Memory Issues**
   ```
   error: Out of memory
   cause: Large response processing
   ```
   - Use streaming for large responses
   - Implement proper cleanup
   - Monitor memory usage

3. **Concurrency Issues**
   ```
   error: Deadlock detected
   cause: Circular wait in async operations
   ```
   - Review async/await usage
   - Check resource locking
   - Implement proper timeouts

## Debugging Tools

### CLI Tools

1. **BAML CLI Debug Mode**
   ```bash
   # Enable debug logging
   RUST_LOG=debug baml generate

   # Trace-level logging
   RUST_LOG=trace baml check
   ```

2. **Compiler Diagnostics**
   ```bash
   # Show detailed error info
   baml check --verbose

   # Show type inference details
   baml check --show-types
   ```

3. **Runtime Diagnostics**
   ```bash
   # Enable runtime debugging
   BAML_DEBUG=1 baml run

   # Profile runtime performance
   BAML_PROFILE=1 baml run
   ```

### Language-Specific Tools

1. **Python**
   ```bash
   # Debug Python client
   PYTHONDEVMODE=1 python -m pytest tests/

   # Profile Python code
   python -m cProfile script.py
   ```

2. **TypeScript**
   ```bash
   # Debug TypeScript client
   NODE_DEBUG=baml node script.js

   # Enable source maps
   NODE_OPTIONS='--enable-source-maps' node script.js
   ```

3. **Ruby**
   ```bash
   # Debug Ruby client
   BAML_DEBUG=1 ruby -d script.rb

   # Profile Ruby code
   ruby-prof script.rb
   ```

## Compiler Debugging

### Setting Up Development Environment

1. **Build with Debug Symbols**
   ```bash
   # Build with debug info
   cargo build --features debug_symbols

   # Run with extra checks
   RUSTFLAGS="-Z debug-assertions" cargo run
   ```

2. **Using LLDB/GDB**
   ```bash
   # Start debugger
   lldb target/debug/baml

   # Set breakpoints
   b baml_lib::parser::parse

   # Run with args
   r generate
   ```

3. **Logging and Tracing**
   ```rust
   // Add debug logging
   debug!("Parsing file: {}", file_path);

   // Add detailed tracing
   trace!("AST node: {:?}", node);
   ```

### Common Debugging Workflows

1. **Parser Issues**
   ```bash
   # Generate parser debug output
   BAML_PARSER_DEBUG=1 baml check

   # View token stream
   BAML_SHOW_TOKENS=1 baml check
   ```

2. **Type Checker Issues**
   ```bash
   # Show type inference steps
   BAML_TYPE_DEBUG=1 baml check

   # Generate type graph
   BAML_TYPE_GRAPH=1 baml check
   ```

3. **Code Generation Issues**
   ```bash
   # Show template context
   BAML_TEMPLATE_DEBUG=1 baml generate

   # Keep intermediate files
   BAML_KEEP_TEMP=1 baml generate
   ```

## Runtime Debugging

### Provider Integration

1. **API Debugging**
   ```bash
   # Enable API request logging
   BAML_LOG_REQUESTS=1 baml run

   # Show rate limit info
   BAML_SHOW_LIMITS=1 baml run
   ```

2. **Response Handling**
   ```bash
   # Log full responses
   BAML_LOG_RESPONSES=1 baml run

   # Show parsing steps
   BAML_PARSE_DEBUG=1 baml run
   ```

### Performance Profiling

1. **CPU Profiling**
   ```bash
   # Generate CPU profile
   BAML_PROFILE_CPU=1 baml run

   # Analyze with pprof
   pprof -http=: cpu.prof
   ```

2. **Memory Profiling**
   ```bash
   # Generate heap profile
   BAML_PROFILE_HEAP=1 baml run

   # Analyze memory usage
   pprof -http=: heap.prof
   ```

## Language Client Debugging

### Python Client

1. **Setup Development Environment**
   ```bash
   # Install development dependencies
   pip install -e ".[dev]"

   # Enable debug logging
   BAML_PY_DEBUG=1 python script.py
   ```

2. **Common Issues**
   - Type conversion errors
   - Async runtime problems
   - Memory leaks in native code

### TypeScript Client

1. **Setup Development Environment**
   ```bash
   # Build with source maps
   npm run build -- --debug

   # Run with inspector
   node --inspect script.js
   ```

2. **Common Issues**
   - Native binding errors
   - Promise handling issues
   - Type definition mismatches

### Ruby Client

1. **Setup Development Environment**
   ```bash
   # Build with debug symbols
   bundle exec rake compile -- --debug

   # Run with debugger
   ruby -r debug script.rb
   ```

2. **Common Issues**
   - FFI binding errors
   - Fiber scheduling issues
   - Memory management problems

## Integration Test Debugging

### Test Environment

1. **Setup**
   ```bash
   # Build test environment
   ./scripts/setup-test-env.sh

   # Run with debug output
   BAML_TEST_DEBUG=1 ./run-tests.sh
   ```

2. **Common Issues**
   - Environment configuration
   - Provider API limits
   - Timing-sensitive tests

### Test Categories

1. **Unit Tests**
   ```bash
   # Run specific test
   cargo test test_name -- --nocapture

   # Show test output
   RUST_LOG=debug cargo test
   ```

2. **Integration Tests**
   ```bash
   # Run with timeout
   BAML_TEST_TIMEOUT=300 ./run-integration-tests.sh

   # Debug specific language
   BAML_TEST_LANG=python ./run-integration-tests.sh
   ```

## VSCode Extension Debugging

### Development Setup

1. **Build Extension**
   ```bash
   # Install dependencies
   npm install

   # Watch for changes
   npm run watch
   ```

2. **Launch Configuration**
   ```json
   {
     "type": "extensionHost",
     "request": "launch",
     "name": "Launch Extension",
     "args": [
       "--extensionDevelopmentPath=${workspaceFolder}"
     ],
     "outFiles": ["${workspaceFolder}/out/**/*.js"]
   }
   ```

### Common Issues

1. **Language Server**
   - Connection problems
   - Command execution failures
   - Syntax highlighting issues

2. **Extension Features**
   - Code completion errors
   - Diagnostic reporting issues
   - Command palette problems

## Best Practices

1. **Logging**
   - Use appropriate log levels
   - Include context in messages
   - Enable debug logs selectively

2. **Error Handling**
   - Provide detailed error messages
   - Include stack traces
   - Log error context

3. **Testing**
   - Write reproducible tests
   - Mock external services
   - Use proper assertions

4. **Performance**
   - Profile before optimizing
   - Monitor resource usage
   - Test with realistic data

## Contributing

When submitting bug reports, please include:

1. BAML version information
2. Minimal reproduction steps
3. Error messages and logs
4. Environment details
5. Related configuration files